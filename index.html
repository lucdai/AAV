<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AAV Analysis Tool</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.1em;
            opacity: 0.95;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }

        .section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        input[type="file"],
        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input[type="file"]:focus,
        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 5px rgba(102, 126, 234, 0.3);
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .download-btn {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            padding: 8px 15px;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .download-btn:hover {
            box-shadow: 0 5px 15px rgba(17, 153, 142, 0.4);
        }

        .batch-download-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            padding: 12px 25px;
            font-size: 1em;
            width: 100%;
            margin-top: 20px;
        }

        .batch-download-btn:hover {
            box-shadow: 0 5px 15px rgba(245, 87, 108, 0.4);
        }

        .output-section {
            grid-column: 1 / -1;
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }

        .output-section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-top: 20px;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .chart-container h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
            margin-bottom: 10px;
        }

        canvas {
            max-width: 100%;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            margin-bottom: 20px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        tr:hover {
            background: #f5f5f5;
        }

        .table-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            position: relative;
        }

        .table-container h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            border-left: 4px solid #c62828;
        }

        .success {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            border-left: 4px solid #2e7d32;
        }

        .info {
            background: #e3f2fd;
            color: #1565c0;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            border-left: 4px solid #1565c0;
        }

        .download-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        .loading {
            display: none;
        }

        .loading.active {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üß¨ AAV Analysis Tool</h1>
            <p>Advanced Analysis and Visualization of Adeno-Associated Virus Data</p>
        </header>

        <div class="main-content">
            <div class="section">
                <h2>üì• Data Input</h2>
                <div class="form-group">
                    <label for="fileInput">Upload CSV File:</label>
                    <input type="file" id="fileInput" accept=".csv" />
                    <small style="color: #999; margin-top: 5px; display: block;">
                        CSV format: One value per line or comma-separated
                    </small>
                </div>
                <button onclick="handleFileUpload()">Parse CSV</button>
                <div id="uploadStatus"></div>
            </div>

            <div class="section">
                <h2>‚öôÔ∏è Configuration</h2>
                <div class="form-group">
                    <label for="binCount">Number of Bins (for Histogram):</label>
                    <input type="number" id="binCount" value="10" min="5" max="50" />
                </div>
                <div class="form-group">
                    <label for="dataLabel">Data Label:</label>
                    <input type="text" id="dataLabel" placeholder="e.g., Virus Titer (vg/mL)" value="Value" />
                </div>
                <button onclick="analyzeData()">Analyze Data</button>
                <div id="analysisStatus"></div>
            </div>
        </div>

        <div class="output-section" id="outputSection" style="display: none;">
            <h2>üìä Analysis Results</h2>
            
            <div id="statusMessage"></div>

            <!-- Download Controls -->
            <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);">
                <h3 style="color: #333; margin-bottom: 15px;">üì• Download Options</h3>
                <button class="batch-download-btn" onclick="downloadAllAsZip()">
                    <span id="zipSpinner"></span> Download All as ZIP
                </button>
                <p style="color: #666; font-size: 0.9em; margin-top: 10px;">
                    üí° Batch download all charts and tables as PNG images in a single ZIP file
                </p>
            </div>

            <!-- Statistics Table -->
            <div class="table-container" id="statsTableContainer" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3>üìà Descriptive Statistics</h3>
                    <button class="download-btn" onclick="downloadTableImage('statsTable', 'statistics-table')">
                        üì• Download as Image
                    </button>
                </div>
                <table id="statsTable">
                    <thead>
                        <tr>
                            <th>Statistic</th>
                            <th>Value</th>
                        </tr>
                    </thead>
                    <tbody id="statsBody"></tbody>
                </table>
            </div>

            <!-- Frequency Distribution Table -->
            <div class="table-container" id="freqTableContainer" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3>üìä Frequency Distribution</h3>
                    <button class="download-btn" onclick="downloadTableImage('freqTable', 'frequency-distribution')">
                        üì• Download as Image
                    </button>
                </div>
                <table id="freqTable">
                    <thead>
                        <tr>
                            <th>Range</th>
                            <th>Frequency</th>
                            <th>Cumulative %</th>
                        </tr>
                    </thead>
                    <tbody id="freqBody"></tbody>
                </table>
            </div>

            <!-- Charts Grid -->
            <div class="charts-grid" id="chartsGrid"></div>
        </div>
    </div>

    <script>
        // Global variables
        let dataArray = [];
        let analysisResults = {};
        const charts = {};

        // Handle file upload
        function handleFileUpload() {
            const fileInput = document.getElementById('fileInput');
            const statusDiv = document.getElementById('uploadStatus');

            if (!fileInput.files.length) {
                statusDiv.innerHTML = '<div class="error">‚ùå Please select a file</div>';
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = (e) => {
                try {
                    const content = e.target.result;
                    // Parse CSV - handle both comma-separated and line-separated values
                    let values = content.replace(/\r/g, '').split(/[\n,]/).filter(v => v.trim());
                    dataArray = values.map(v => parseFloat(v.trim())).filter(v => !isNaN(v));

                    if (dataArray.length === 0) {
                        throw new Error('No valid numeric data found in file');
                    }

                    statusDiv.innerHTML = `<div class="success">‚úÖ Loaded ${dataArray.length} data points successfully</div>`;
                } catch (error) {
                    statusDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
                    dataArray = [];
                }
            };

            reader.readAsText(file);
        }

        // Analyze data
        function analyzeData() {
            const statusDiv = document.getElementById('analysisStatus');

            if (dataArray.length === 0) {
                statusDiv.innerHTML = '<div class="error">‚ùå Please upload and parse data first</div>';
                return;
            }

            try {
                const binCount = parseInt(document.getElementById('binCount').value);
                const dataLabel = document.getElementById('dataLabel').value || 'Value';

                // Calculate statistics
                analysisResults = calculateStatistics(dataArray, binCount);
                analysisResults.dataLabel = dataLabel;

                // Display results
                displayStatistics();
                displayFrequencyTable();
                displayCharts();

                document.getElementById('outputSection').style.display = 'block';
                statusDiv.innerHTML = '<div class="success">‚úÖ Analysis completed successfully</div>';
            } catch (error) {
                statusDiv.innerHTML = `<div class="error">‚ùå Analysis error: ${error.message}</div>`;
            }
        }

        // Calculate statistics
        function calculateStatistics(data, binCount) {
            const sorted = [...data].sort((a, b) => a - b);
            const n = sorted.length;

            // Basic statistics
            const mean = data.reduce((a, b) => a + b) / n;
            const variance = data.reduce((sq, n) => sq + Math.pow(n - mean, 2), 0) / n;
            const stdDev = Math.sqrt(variance);
            const min = Math.min(...data);
            const max = Math.max(...data);
            const range = max - min;

            // Quartiles
            const q1 = sorted[Math.floor(n * 0.25)];
            const median = sorted[Math.floor(n * 0.5)];
            const q3 = sorted[Math.floor(n * 0.75)];
            const iqr = q3 - q1;

            // Skewness and Kurtosis
            const skewness = data.reduce((sum, x) => sum + Math.pow((x - mean) / stdDev, 3), 0) / n;
            const kurtosis = (data.reduce((sum, x) => sum + Math.pow((x - mean) / stdDev, 4), 0) / n) - 3;

            // Frequency distribution
            const binWidth = range / binCount;
            const bins = Array(binCount).fill(0);
            const binEdges = [];

            for (let i = 0; i <= binCount; i++) {
                binEdges.push(min + i * binWidth);
            }

            data.forEach(value => {
                let binIndex = Math.floor((value - min) / binWidth);
                if (binIndex === binCount) binIndex = binCount - 1;
                bins[binIndex]++;
            });

            return {
                n,
                mean,
                stdDev,
                variance,
                min,
                max,
                range,
                q1,
                median,
                q3,
                iqr,
                skewness,
                kurtosis,
                bins,
                binEdges,
                binCount
            };
        }

        // Display statistics table
        function displayStatistics() {
            const statsBody = document.getElementById('statsBody');
            const stats = analysisResults;

            const rows = [
                ['Count', stats.n],
                ['Mean', stats.mean.toFixed(4)],
                ['Median', stats.median.toFixed(4)],
                ['Std Dev', stats.stdDev.toFixed(4)],
                ['Variance', stats.variance.toFixed(4)],
                ['Min', stats.min.toFixed(4)],
                ['Max', stats.max.toFixed(4)],
                ['Range', stats.range.toFixed(4)],
                ['Q1', stats.q1.toFixed(4)],
                ['Q3', stats.q3.toFixed(4)],
                ['IQR', stats.iqr.toFixed(4)],
                ['Skewness', stats.skewness.toFixed(4)],
                ['Kurtosis', stats.kurtosis.toFixed(4)]
            ];

            statsBody.innerHTML = rows.map(([label, value]) => 
                `<tr><td>${label}</td><td>${value}</td></tr>`
            ).join('');

            document.getElementById('statsTableContainer').style.display = 'block';
        }

        // Display frequency distribution table
        function displayFrequencyTable() {
            const freqBody = document.getElementById('freqBody');
            const stats = analysisResults;

            let cumulativeCount = 0;
            const rows = [];

            for (let i = 0; i < stats.binCount; i++) {
                const lower = stats.binEdges[i].toFixed(4);
                const upper = stats.binEdges[i + 1].toFixed(4);
                const count = stats.bins[i];
                cumulativeCount += count;
                const cumulativePercent = ((cumulativeCount / stats.n) * 100).toFixed(2);

                rows.push(`
                    <tr>
                        <td>${lower} - ${upper}</td>
                        <td>${count}</td>
                        <td>${cumulativePercent}%</td>
                    </tr>
                `);
            }

            freqBody.innerHTML = rows.join('');
            document.getElementById('freqTableContainer').style.display = 'block';
        }

        // Display charts
        function displayCharts() {
            const grid = document.getElementById('chartsGrid');
            grid.innerHTML = '';

            const stats = analysisResults;
            const dataLabel = analysisResults.dataLabel;

            // Histogram
            const histogramContainer = createChartContainer('histogram', 'Histogram - Frequency Distribution');
            grid.appendChild(histogramContainer);
            createHistogram('histogramChart', stats, dataLabel);

            // Box Plot
            const boxplotContainer = createChartContainer('boxplot', 'Box Plot');
            grid.appendChild(boxplotContainer);
            createBoxPlot('boxplotChart', stats, dataLabel);

            // Cumulative Distribution
            const cdfContainer = createChartContainer('cdf', 'Cumulative Distribution Function (CDF)');
            grid.appendChild(cdfContainer);
            createCDF('cdfChart', dataArray, dataLabel);

            // Normal Q-Q Plot
            const qqContainer = createChartContainer('qq', 'Normal Q-Q Plot');
            grid.appendChild(qqContainer);
            createQQPlot('qqChart', dataArray, dataLabel);

            // Distribution Curve
            const curveContainer = createChartContainer('curve', 'Distribution Curve');
            grid.appendChild(curveContainer);
            createDistributionCurve('curveChart', stats, dataLabel);

            // Density Plot
            const densityContainer = createChartContainer('density', 'Density Plot');
            grid.appendChild(densityContainer);
            createDensityPlot('densityChart', dataArray, dataLabel);
        }

        // Create chart container
        function createChartContainer(id, title) {
            const container = document.createElement('div');
            container.className = 'chart-container';
            container.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3>${title}</h3>
                    <button class="download-btn" onclick="downloadChartImage('${id}', '${title.toLowerCase().replace(/\s+/g, '-')}')">
                        üì• Download
                    </button>
                </div>
                <div class="chart-wrapper">
                    <canvas id="${id}Chart"></canvas>
                </div>
            `;
            return container;
        }

        // Chart creation functions
        function createHistogram(canvasId, stats, dataLabel) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            const labels = [];
            for (let i = 0; i < stats.binCount; i++) {
                labels.push(`${stats.binEdges[i].toFixed(2)}-${stats.binEdges[i + 1].toFixed(2)}`);
            }

            charts[canvasId] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Frequency',
                        data: stats.bins,
                        backgroundColor: 'rgba(102, 126, 234, 0.7)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function createBoxPlot(canvasId, stats, dataLabel) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            charts[canvasId] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Data'],
                    datasets: [
                        {
                            label: 'Min',
                            data: [stats.min],
                            backgroundColor: 'rgba(211, 84, 0, 0.5)'
                        },
                        {
                            label: 'Q1',
                            data: [stats.q1],
                            backgroundColor: 'rgba(255, 154, 0, 0.5)'
                        },
                        {
                            label: 'Median',
                            data: [stats.median - stats.q1],
                            backgroundColor: 'rgba(76, 175, 80, 0.7)'
                        },
                        {
                            label: 'Q3',
                            data: [stats.q3 - stats.median],
                            backgroundColor: 'rgba(255, 154, 0, 0.5)'
                        },
                        {
                            label: 'Max',
                            data: [stats.max - stats.q3],
                            backgroundColor: 'rgba(211, 84, 0, 0.5)'
                        }
                    ]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: true }
                    }
                }
            });
        }

        function createCDF(canvasId, data, dataLabel) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            const sorted = [...data].sort((a, b) => a - b);
            
            const cdfData = sorted.map((val, i) => ({
                x: val,
                y: ((i + 1) / sorted.length) * 100
            }));

            charts[canvasId] = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'CDF',
                        data: cdfData,
                        borderColor: 'rgba(102, 126, 234, 1)',
                        backgroundColor: 'rgba(102, 126, 234, 0.3)',
                        showLine: true,
                        fill: false,
                        borderWidth: 2,
                        pointRadius: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: { display: true, text: 'Cumulative Percentage (%)' }
                        },
                        x: {
                            title: { display: true, text: dataLabel }
                        }
                    }
                }
            });
        }

        function createQQPlot(canvasId, data, dataLabel) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            const sorted = [...data].sort((a, b) => a - b);
            const n = sorted.length;
            
            // Calculate theoretical quantiles (normal distribution)
            const qqData = [];
            for (let i = 0; i < n; i++) {
                const p = (i + 1) / (n + 1);
                const theoretical = inverseNormalCDF(p);
                qqData.push({
                    x: theoretical,
                    y: sorted[i]
                });
            }

            charts[canvasId] = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Q-Q Plot',
                        data: qqData,
                        borderColor: 'rgba(102, 126, 234, 1)',
                        backgroundColor: 'rgba(102, 126, 234, 0.5)',
                        showLine: false,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true }
                    },
                    scales: {
                        y: {
                            title: { display: true, text: 'Sample Quantiles' }
                        },
                        x: {
                            title: { display: true, text: 'Theoretical Quantiles' }
                        }
                    }
                }
            });
        }

        function createDistributionCurve(canvasId, stats, dataLabel) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            const points = [];
            const min = stats.min - stats.range * 0.1;
            const max = stats.max + stats.range * 0.1;
            
            for (let x = min; x <= max; x += (max - min) / 100) {
                const y = normalDistribution(x, stats.mean, stats.stdDev);
                points.push({ x: x, y: y });
            }

            charts[canvasId] = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Normal Distribution',
                        data: points,
                        borderColor: 'rgba(102, 126, 234, 1)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        showLine: true,
                        fill: true,
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Density' }
                        },
                        x: {
                            title: { display: true, text: dataLabel }
                        }
                    }
                }
            });
        }

        function createDensityPlot(canvasId, data, dataLabel) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            const kernel = epanechnikovKernel;
            const bandwidth = 1.06 * Math.sqrt(variance(data)) * Math.pow(data.length, -1/5);
            
            const min = Math.min(...data);
            const max = Math.max(...data);
            const range = max - min;
            
            const densityData = [];
            for (let x = min - range * 0.1; x <= max + range * 0.1; x += range / 100) {
                let density = 0;
                data.forEach(d => {
                    density += kernel((x - d) / bandwidth) / (bandwidth * data.length);
                });
                densityData.push({ x: x, y: density });
            }

            charts[canvasId] = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'KDE',
                        data: densityData,
                        borderColor: 'rgba(118, 75, 162, 1)',
                        backgroundColor: 'rgba(118, 75, 162, 0.1)',
                        showLine: true,
                        fill: true,
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Density' }
                        },
                        x: {
                            title: { display: true, text: dataLabel }
                        }
                    }
                }
            });
        }

        // Utility functions for statistical calculations
        function inverseNormalCDF(p) {
            const a1 = -3.969683028665376e+01;
            const a2 = 2.221222899801429e+02;
            const a3 = -2.821152023902548e+02;
            const a4 = 1.340426573720606e+02;
            const a5 = -2.040352747538567e+01;
            const a6 = 3.226671290700398e-01;
            const b1 = -5.447609879822406e+01;
            const b2 = 1.615858368580409e+02;
            const b3 = -1.556989798598866e+02;
            const b4 = 6.680131188771972e+01;
            const b5 = -1.328068155288572e+01;
            const c1 = -7.784894002430293e-03;
            const c2 = -3.223964580411365e-01;
            const c3 = -2.400758277161838e+00;
            const c4 = -2.549732539343734e+00;
            const c5 = 4.374664141464968e+00;
            const c6 = 2.938163357918667e+00;
            const d1 = 7.784695709041462e-03;
            const d2 = 3.224671290700398e-01;
            const d3 = 2.445134137142996e+00;
            const d4 = 3.754408661907416e+00;
            const p_low = 0.02425;
            const p_high = 1 - p_low;
            let q, r, val;

            if ((p < 0) || (p > 1)) {
                return NaN;
            } else if (p < p_low) {
                q = Math.sqrt(-2 * Math.log(p));
                return (((((c1 * q + c2) * q + c3) * q + c4) * q + c5) * q + c6) / ((((d1 * q + d2) * q + d3) * q + d4) * q + 1);
            } else if (p <= p_high) {
                q = p - 0.5;
                r = q * q;
                return (((((a1 * r + a2) * r + a3) * r + a4) * r + a5) * r + a6) * q / (((((b1 * r + b2) * r + b3) * r + b4) * r + b5) * r + 1);
            } else {
                q = Math.sqrt(-2 * Math.log(1 - p));
                return -(((((c1 * q + c2) * q + c3) * q + c4) * q + c5) * q + c6) / ((((d1 * q + d2) * q + d3) * q + d4) * q + 1);
            }
        }

        function normalDistribution(x, mu, sigma) {
            return (1 / (sigma * Math.sqrt(2 * Math.PI))) * Math.exp(-0.5 * Math.pow((x - mu) / sigma, 2));
        }

        function epanechnikovKernel(u) {
            if (Math.abs(u) <= 1) {
                return 0.75 * (1 - u * u);
            }
            return 0;
        }

        function variance(data) {
            const mean = data.reduce((a, b) => a + b) / data.length;
            return data.reduce((sq, n) => sq + Math.pow(n - mean, 2), 0) / data.length;
        }

        // Download functions
        async function downloadChartImage(chartId, filename) {
            try {
                const canvas = document.getElementById(chartId + 'Chart');
                const link = document.createElement('a');
                link.href = canvas.toDataURL('image/png');
                link.download = `${filename}.png`;
                link.click();
            } catch (error) {
                alert('Error downloading chart: ' + error.message);
            }
        }

        async function downloadTableImage(tableId, filename) {
            try {
                const table = document.getElementById(tableId);
                const canvas = await html2canvas(table, {
                    backgroundColor: '#ffffff',
                    scale: 2
                });
                const link = document.createElement('a');
                link.href = canvas.toDataURL('image/png');
                link.download = `${filename}.png`;
                link.click();
            } catch (error) {
                alert('Error downloading table: ' + error.message);
            }
        }

        async function downloadAllAsZip() {
            try {
                const zipButton = document.querySelector('.batch-download-btn');
                const originalText = zipButton.textContent;
                
                // Show loading state
                zipButton.innerHTML = '<span class="spinner"></span> Preparing files...';
                zipButton.disabled = true;

                const zip = new JSZip();
                const timestamp = new Date().toISOString().slice(0, 10);

                // Add all chart images
                const chartIds = ['histogramChart', 'boxplotChart', 'cdfChart', 'qqChart', 'curveChart', 'densityChart'];
                const chartNames = ['histogram', 'box-plot', 'cumulative-distribution', 'qq-plot', 'distribution-curve', 'density-plot'];

                for (let i = 0; i < chartIds.length; i++) {
                    const canvas = document.getElementById(chartIds[i]);
                    const dataUrl = canvas.toDataURL('image/png');
                    const data = dataUrl.replace(/^data:image\/png;base64,/, '');
                    zip.file(`charts/${chartNames[i]}.png`, data, { binary: true });
                }

                // Add table images
                const tables = [
                    { id: 'statsTable', name: 'statistics-table' },
                    { id: 'freqTable', name: 'frequency-distribution' }
                ];

                for (const table of tables) {
                    const element = document.getElementById(table.id);
                    const canvas = await html2canvas(element, {
                        backgroundColor: '#ffffff',
                        scale: 2
                    });
                    const dataUrl = canvas.toDataURL('image/png');
                    const data = dataUrl.replace(/^data:image\/png;base64,/, '');
                    zip.file(`tables/${table.name}.png`, data, { binary: true });
                }

                // Add a summary text file
                const summary = `AAV Analysis Report
Generated: ${new Date().toLocaleString()}

Total Data Points: ${analysisResults.n}
Mean: ${analysisResults.mean.toFixed(4)}
Median: ${analysisResults.median.toFixed(4)}
Std Dev: ${analysisResults.stdDev.toFixed(4)}
Min: ${analysisResults.min.toFixed(4)}
Max: ${analysisResults.max.toFixed(4)}
Range: ${analysisResults.range.toFixed(4)}

Files included:
- charts/: All distribution and analysis charts (PNG)
- tables/: Statistical and frequency tables (PNG)
`;
                zip.file('README.txt', summary);

                // Generate and download ZIP
                const content = await zip.generateAsync({ type: 'blob' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(content);
                link.download = `aav-analysis-${timestamp}.zip`;
                link.click();

                // Reset button
                zipButton.textContent = originalText;
                zipButton.disabled = false;

                // Show success message
                const statusDiv = document.getElementById('statusMessage');
                statusDiv.innerHTML = '<div class="success">‚úÖ ZIP file downloaded successfully!</div>';
                setTimeout(() => {
                    statusDiv.innerHTML = '';
                }, 5000);

            } catch (error) {
                console.error('Error creating ZIP:', error);
                alert('Error creating ZIP file: ' + error.message);
                const zipButton = document.querySelector('.batch-download-btn');
                zipButton.textContent = originalText;
                zipButton.disabled = false;
            }
        }

        // Initialize on page load
        window.addEventListener('load', () => {
            console.log('AAV Analysis Tool loaded successfully');
        });
    </script>
</body>
</html>