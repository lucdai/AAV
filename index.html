<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-site-verification" content="fXJfMAunV28mGhWAkEsbJfoqN2JfBPXUcdf8jY1TWEc" />
    <title data-i18n="title">AAV - Công cụ Phân Tích & Trực Quan Hóa Dữ Liệu Trực Tuyến</title>
    <meta name="description" content="AAV là công cụ trực tuyến miễn phí giúp phân tích thống kê, tính toán tần số và trực quan hóa dữ liệu với hơn 12 loại biểu đồ chuyên nghiệp. Dễ dàng chia sẻ và xuất dữ liệu.">
    <meta name="keywords" content="AAV, phân tích dữ liệu, trực quan hóa dữ liệu, biểu đồ thống kê, công cụ thống kê online, vẽ biểu đồ trực tuyến, phân tích tần số, data visualization tool">
    <meta name="author" content="lucdai">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://lucdai.github.io/AAV/">
    <meta property="og:title" content="AAV - Công cụ Phân Tích & Trực Quan Hóa Dữ Liệu">
    <meta property="og:description" content="Phân tích thống kê và tạo biểu đồ chuyên nghiệp chỉ trong vài giây với AAV.">
    <meta property="og:image" content="https://lucdai.github.io/AAV/logo.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://lucdai.github.io/AAV/">
    <meta property="twitter:title" content="AAV - Công cụ Phân Tích & Trực Quan Hóa Dữ Liệu">
    <meta property="twitter:description" content="Phân tích thống kê và tạo biểu đồ chuyên nghiệp chỉ trong vài giây với AAV.">
    <meta property="twitter:image" content="https://lucdai.github.io/AAV/logo.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="48x48" href="favicon-48x48.png">
    <link rel="apple-touch-icon" sizes="180x180" href="favicon-192x192.png">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "AAV - Phân Tích & Trực Quan Hóa Dữ Liệu",
      "url": "https://lucdai.github.io/AAV/",
      "description": "Công cụ trực tuyến miễn phí để phân tích thống kê và trực quan hóa dữ liệu.",
      "applicationCategory": "BusinessApplication",
      "operatingSystem": "All",
      "author": {
        "@type": "Person",
        "name": "lucdai"
      }
    }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://unpkg.com/@sgratzl/chartjs-chart-boxplot@3.10.0/build/index.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>
    <script src="calculation_details.js"></script>
    <script src="localStorage.js"></script>
    <script src="i18n.js"></script>
    <script>
        // Hàm tạo chuỗi ngẫu nhiên 21 ký tự đa ngôn ngữ
        function generateRandomFilename() {
            const chars = 
                '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ' + // Latin/Digits
                'АБВГДЕЁЖЗИЙКЛМНОПРСТУФХЦЧШЩЪЫЬЭЮЯабвгдеёжзийклмнопрстуфхцчшщъыьэюя' + // Cyrillic (Nga)
                'अआइईउऊऋएऐओऔकखगघङचछजझञटठडढणतथदधनपफबभमयरलवशषसह' + // Devanagari (Phạn Ngữ)
                'IVXLCDM' + // Roman Numerals (La Mã)
                'ΑΒΓΔΕΖΗΘΙΚΛΜΝΞΟΠΡΣΤΥΦΧΨΩαβγδεζηθικλμνξοπρστυφχψω' + // Greek (Hy Lạp)
                '가나다라마바사아자차카타파하' + // Hangul (Hàn Quốc)
                '你好世界人中大上下左右' + // Hanzi (Trung Quốc)
                'あいうえおかきくけこサシスセソ' + // Japanese (Hiragana/Katakana)
                'ÁÀẢÃẠĂẰẮẲẴẶÂẦẤẨẪẬĐÈÉẺẼẸÊỀẾỂỄỆÌÍỈĨỊÒÓỎÕỌÔỒỐỔỖỘƠỜỚỞỠỢÙÚỦŨỤƯỪỨỬỮỰỲÝỶỸỴáàảãạăằắẳẵặâầấẩẫậđèéẻẽẹêềếểễệìíỉĩịòóỏõọôồốổỗộơờớởỡợùúủũụưừứửữựỳýỷỹỵ' + // Vietnamese
                '+−×÷=≠≈≤≥√∑∫∂∞π€$£%^&*()_+-=[]{};\':"\\|,./<>?!@#'; // Mathematical/Special Symbols
            
            let result = '';
            for (let i = 0; i < 21; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif:ital,wght@0,400;0,700;1,400&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .font-serif { font-family: 'Noto Serif', serif; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .input-cell:focus { outline: 2px solid #6366f1; background: white; }
        .tab-btn.active { border-bottom: 2px solid #4f46e5; color: #4f46e5; font-weight: 600; }
        .tab-btn { color: #64748b; font-weight: 500; }
        .logo-container {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .logo-container:hover {
            transform: scale(1.05);
            filter: drop-shadow(0 8px 16px rgba(0, 0, 0, 0.15));
        }

        /* MATH TYPOGRAPHY STYLES */
        .math-text { font-family: 'Noto Serif', serif; font-size: 1.1rem; color: #1e293b; line-height: 1.6; }
        .formula-container { display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 6px; margin: 15px 0; padding: 15px; background: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0; }
        .fraction { display: inline-flex; flex-direction: column; align-items: center; vertical-align: middle; margin: 0 4px; }
        .numerator { border-bottom: 1.5px solid #000; padding: 0 6px 2px 6px; text-align: center; width: 100%; }
        .denominator { padding: 2px 6px 0 6px; text-align: center; width: 100%; }
        .math-symbol { font-style: italic; margin-right: 2px; }
        .sub { font-size: 0.75em; vertical-align: sub; line-height: 0; }
        .sup { font-size: 0.75em; vertical-align: super; line-height: 0; }
        .delta-symbol { font-style: normal; font-family: 'Noto Serif', serif; font-size: 1.1em; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen p-4 md:p-6">
    <!-- SEO Content for Search Engines -->
    <div class="sr-only" style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0;"><p data-i18n="welcome_msg"></p><p data-i18n="welcome_msg_2"></p></div>

    <!-- MODAL FOR CALCULATION DETAILS -->
    <div id="calcModal" class="fixed inset-0 bg-slate-900/50 z-50 hidden items-center justify-center p-4 backdrop-blur-sm">
        <div id="calcModalContent" class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] flex flex-col overflow-hidden border border-slate-200">
            <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h3 id="calcModalTitle" class="font-bold text-slate-800 flex items-center gap-2">
                    <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <span data-i18n="calc_details">Chi tiết phép tính</span>
                </h3>
                <div class="flex items-center gap-2">
                    <button onclick="downloadCalcImage()" class="p-2 text-slate-500 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition" data-i18n-title="download_calc_img">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    </button>
                    <button onclick="closeCalcModal()" class="p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
            </div>
            <div id="calcModalBody" class="p-6 overflow-y-auto text-slate-700 leading-relaxed">
                <!-- Content will be injected here -->
            </div>
            <div class="p-4 border-t border-slate-100 bg-slate-50 text-right">
                <button onclick="closeCalcModal()" class="px-4 py-2 bg-white border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 transition font-medium text-sm"><span data-i18n="close">Đóng</span></button>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto space-y-4">
        
        <!-- HEADER -->
        <header class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-3 cursor-pointer logo-container" onclick="goHome()">
                <img src="logo.png" alt="AAV - Công cụ phân tích và trực quan hóa dữ liệu thống kê chuyên nghiệp" class="h-12 w-auto">
                <h1 class="text-xl font-bold text-slate-900" data-i18n="title">AAV - Phân Tích & Trực Quan Hóa Dữ Liệu</h1>
            </div>
            
            <div id="languageSwitcher" class="mr-2"></div><div class="flex items-center gap-3">
                <div class="flex items-center gap-2 mr-2">
                    <span class="text-sm font-medium text-slate-600"><span data-i18n="rounding"></span></span>
                    <input type="number" id="decimalPlaces" value="2" min="0" max="10" class="w-16 p-1.5 text-center border border-slate-300 rounded focus:ring-2 focus:ring-indigo-500 font-mono text-sm" onchange="calculate()">
                </div>
                <div class="relative group">
                    <button class="flex items-center gap-2 bg-slate-600 hover:bg-slate-700 text-white px-4 py-2 rounded-lg shadow-sm font-medium transition text-sm" data-i18n-title="backup_mgmt">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path></svg>
                        <span data-i18n="backup"></span>
                    </button>
                    <div class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl border border-slate-200 hidden group-hover:block z-50">
                        <button onclick="saveToLocalStorage()" class="w-full text-left px-4 py-2 hover:bg-slate-50 text-slate-700 text-sm flex items-center gap-2 border-b border-slate-100">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                            <span data-i18n="save_now">Lưu ngay</span>
                        </button>
                        <button onclick="exportBackupAsJSON()" class="w-full text-left px-4 py-2 hover:bg-slate-50 text-slate-700 text-sm flex items-center gap-2 border-b border-slate-100">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            <span data-i18n="export_json_btn">Xuất JSON</span>
                        </button>
                        <button onclick="importBackupFromJSON()" class="w-full text-left px-4 py-2 hover:bg-slate-50 text-slate-700 text-sm flex items-center gap-2 border-b border-slate-100">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1m-4-4l-4-4m0 0l4-4m-4 4h12"></path></svg>
                            <span data-i18n="import_json_btn">Nhập JSON</span>
                        </button>
                        <button onclick="clearBackup()" class="w-full text-left px-4 py-2 hover:bg-red-50 text-red-600 text-sm flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            <span data-i18n="clear_backup">Xóa sao lưu</span>
                        </button>
                    </div>
                </div>
                <button onclick="shareLink()" class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg shadow-sm font-medium transition text-sm">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 100-2.684 3 3 0 000 2.684zm0 9a3 3 0 100-2.684 3 3 0 000 2.684z"></path></svg>
                    <span data-i18n="share"></span>
                </button>
            </div>
        </header>

        <!-- TAB NAVIGATION -->
        <nav class="flex border-b border-slate-200 bg-white rounded-t-xl px-6 shadow-sm overflow-x-auto">
            <button onclick="switchTab('data')" id="tabDataBtn" class="tab-btn active px-6 py-4 transition-colors whitespace-nowrap">
                <span data-i18n="data_stats">Dữ liệu & Thống kê</span>
            </button>
            <button onclick="switchTab('charts')" id="tabChartsBtn" class="tab-btn px-6 py-4 transition-colors flex items-center gap-2 whitespace-nowrap">
                <span data-i18n="chart_library">Kho Biểu Đồ</span>
                <span class="bg-indigo-100 text-indigo-700 text-xs px-2 py-0.5 rounded-full"><span id="chartCount">12</span> <span data-i18n="actions">loại</span></span>
            </button>
        </nav>

        <!-- ================= TAB 1: DATA & STATS ================= -->
        <div id="tabDataContent" class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <!-- LEFT COLUMN: INPUTS -->
            <div class="lg:col-span-4 space-y-4">
                <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-200 flex gap-2">
                    <button onclick="switchInputMode('raw')" id="btnRaw" class="flex-1 py-2 text-sm font-medium rounded bg-indigo-50 text-indigo-700"><span data-i18n="raw_data_tab">Dữ liệu thô</span></button>
                    <button onclick="switchInputMode('table')" id="btnTable" class="flex-1 py-2 text-sm font-medium rounded text-slate-500 hover:bg-slate-50"><span data-i18n="freq_table_tab">Bảng tần số</span></button>
                </div>

                <div class="flex gap-2">
                    <button onclick="addDataset()" class="flex-1 text-xs bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded shadow-sm font-medium transition" data-i18n="add_sample">Thêm Mẫu</button>
                    <button onclick="removeLastDataset()" class="flex-1 text-xs bg-white border border-slate-300 text-slate-600 hover:text-red-600 py-2 rounded shadow-sm font-medium transition" data-i18n="remove_sample">Xóa Mẫu</button>
                    <button onclick="document.getElementById('csvInput').click()" class="flex-1 text-xs bg-emerald-600 hover:bg-emerald-700 text-white py-2 rounded shadow-sm font-medium transition" data-i18n="import_csv">Nhập CSV</button>
                    <input type="file" id="csvInput" accept=".csv" class="hidden" onchange="handleCSV(this)">
                </div>

                <!-- RAW INPUT -->
                <div id="rawSection" class="space-y-3">
                    <div id="datasetContainer" class="space-y-3 max-h-[400px] overflow-y-auto pr-1"></div>
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
                        <div class="font-bold text-slate-700 mb-3 text-xs uppercase" data-i18n="group_config"></div>
                        <div class="space-y-3">
                            <select id="method" onchange="toggleInputs(); calculate()" class="w-full p-2 border border-slate-300 rounded text-sm bg-white"><option value="auto" data-i18n="auto">Tự động</option><option value="manual_width" data-i18n="fixed_width">Cố định độ rộng (h)</option><option value="manual_count" data-i18n="fixed_count">Cố định số nhóm (k)</option></select>
                            <div id="inputH" class="hidden"><input type="number" id="manualH" value="5" min="0.1" step="0.1" class="w-full p-2 border border-slate-300 rounded text-sm" placeholder="Độ rộng (h)" data-i18n-placeholder="width_h" onchange="calculate()"></div>
                            <div id="inputK" class="hidden"><input type="number" id="manualK" value="6" min="1" max="50" class="w-full p-2 border border-slate-300 rounded text-sm" placeholder="Số nhóm (k)" data-i18n-placeholder="count_k" onchange="calculate()"></div>
                            <div id="inputStart" class="hidden"><input type="number" id="startValue" placeholder="Giá trị bắt đầu" data-i18n-placeholder="start_val_placeholder" class="w-full p-2 border border-slate-300 rounded text-sm" onchange="calculate()"></div>
                        </div>
                    </div>
                </div>

                <!-- TABLE INPUT -->
                <div id="tableSection" class="hidden bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-3 bg-slate-50 border-b border-slate-200 flex justify-between items-center">
                        <h3 class="font-bold text-sm text-slate-700" data-i18n="input_table_title">Nhập Bảng</h3>
                        <button onclick="addManualRow()" class="text-xs bg-white border px-2 py-1 rounded hover:bg-indigo-50 text-indigo-700" data-i18n="add_group"></button>
                    </div>
                    <div class="p-2 overflow-x-auto"><table class="w-full text-xs" id="manualInputTable"><thead><tr id="manualHeaderRow"></tr></thead><tbody id="manualBody"></tbody></table></div>
                </div>
            </div>

            <!-- RIGHT COLUMN: TABLES -->
            <div class="lg:col-span-8">
                <!-- Wrapper for Results -->
                <div id="resultsSection" class="hidden space-y-6">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="p-4 bg-slate-50 border-b border-slate-200 flex justify-between items-center">
                            <h2 class="font-bold text-slate-800 text-sm uppercase" data-i18n="freq_analysis_title">Phân Tích Bảng Phân Bố Tần Số Thống Kê</h2>
                            <div class="flex gap-2">
                                <button onclick="copyTable()" class="text-xs border bg-white px-3 py-1 rounded hover:text-indigo-600" data-i18n="copy"></button>
                                <button onclick="downloadTableImage('freqTable', 'Bảng_Phân_Bố_Tần_Số', 'png')" class="text-xs border bg-white px-3 py-1 rounded hover:text-green-600 flex items-center gap-1">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                    <span data-i18n="export_png">PNG</span>
                                </button>
                                <button onclick="downloadTableImage('freqTable', 'Bảng_Phân_Bố_Tần_Số', 'jpeg')" class="text-xs border bg-white px-3 py-1 rounded hover:text-blue-600 flex items-center gap-1">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                    <span data-i18n="export_jpeg">JPEG</span>
                                </button>
                            </div>
                        </div>
                        <div class="overflow-x-auto"><table class="w-full text-sm text-left" id="freqTable"></table></div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="p-4 bg-slate-50 border-b border-slate-200 flex justify-between items-center">
                            <h2 class="font-bold text-slate-800 text-sm uppercase" data-i18n="desc_stats_title">Các Chỉ Số Thống Kê Mô Tả Chi Tiết</h2>
                            <div class="flex gap-2">
                                <button onclick="downloadTableImage('statsTable', 'Bảng_Các_Chỉ_Số_Thống_Kê', 'png')" class="text-xs border bg-white px-3 py-1 rounded hover:text-green-600 flex items-center gap-1">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                    PNG
                                </button>
                                <button onclick="downloadTableImage('statsTable', 'Bảng_Các_Chỉ_Số_Thống_Kê', 'jpeg')" class="text-xs border bg-white px-3 py-1 rounded hover:text-blue-600 flex items-center gap-1">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                    JPEG
                                </button>
                            </div>
                        </div>
                        <div class="overflow-x-auto"><table class="w-full text-sm text-left" id="statsTable"></table></div>
                    </div>
                </div>
                
                <!-- Empty State Data -->
                <div id="emptyState" class="hidden h-96 flex flex-col items-center justify-center text-slate-400 bg-slate-50 border-2 border-dashed border-slate-200 rounded-xl">
                    <svg class="w-12 h-12 mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    <p class="text-sm" data-i18n="enter_data_msg">Vui lòng nhập dữ liệu để xem kết quả</p>
                </div>
            </div>
        </div>

        <!-- ================= TAB 2: VISUALIZATION ================= -->
        <div id="tabChartsContent" class="hidden">
            
            <!-- Charts Wrapper -->
            <div id="chartsWrapper" class="hidden space-y-6">
                <h3 class="text-lg font-bold text-slate-800 border-b pb-2" data-i18n="basic_dist_comp"></h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-slate-700 text-center flex-1" data-i18n="histogram_name"></h3>
                            <div class="flex gap-1">
                                <button onclick="downloadChartImage('chartHistogram', t('histogram_name'), 'png')" class="text-xs border bg-white px-2 py-1 rounded hover:text-green-600">PNG</button>
                                <button onclick="downloadChartImage('chartHistogram', t('histogram_name'), 'jpeg')" class="text-xs border bg-white px-2 py-1 rounded hover:text-blue-600">JPEG</button>
                            </div>
                        </div>
                        <div class="h-64 relative w-full"><canvas id="chartHistogram"></canvas></div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-slate-700 text-center flex-1" data-i18n="polygon_name"></h3>
                            <div class="flex gap-1">
                                <button onclick="downloadChartImage('chartPolygon', t('polygon_name'), 'png')" class="text-xs border bg-white px-2 py-1 rounded hover:text-green-600">PNG</button>
                                <button onclick="downloadChartImage('chartPolygon', t('polygon_name'), 'jpeg')" class="text-xs border bg-white px-2 py-1 rounded hover:text-blue-600">JPEG</button>
                            </div>
                        </div>
                        <div class="h-64 relative w-full"><canvas id="chartPolygon"></canvas></div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-slate-700 text-center flex-1" data-i18n="stacked_bar_name"></h3>
                            <div class="flex gap-1">
                                <button onclick="downloadChartImage('chartStacked', t('stacked_bar_name'), 'png')" class="text-xs border bg-white px-2 py-1 rounded hover:text-green-600">PNG</button>
                                <button onclick="downloadChartImage('chartStacked', t('stacked_bar_name'), 'jpeg')" class="text-xs border bg-white px-2 py-1 rounded hover:text-blue-600">JPEG</button>
                            </div>
                        </div>
                        <div class="h-64 relative w-full"><canvas id="chartStacked"></canvas></div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-slate-700 text-center flex-1" data-i18n="rel_freq_bar_name"></h3>
                            <div class="flex gap-1">
                                <button onclick="downloadChartImage('chartRelFreq', t('rel_freq_bar_name'), 'png')" class="text-xs border bg-white px-2 py-1 rounded hover:text-green-600">PNG</button>
                                <button onclick="downloadChartImage('chartRelFreq', t('rel_freq_bar_name'), 'jpeg')" class="text-xs border bg-white px-2 py-1 rounded hover:text-blue-600">JPEG</button>
                            </div>
                        </div>
                        <div class="h-64 relative w-full"><canvas id="chartRelFreq"></canvas></div>
                    </div>
                </div>

                <h3 class="text-lg font-bold text-slate-800 border-b pb-2 pt-4" data-i18n="advanced_stats"></h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-slate-700 text-center flex-1" data-i18n="violin_name"></h3>
                            <div class="flex gap-1">
                                <button onclick="downloadChartImage('chartViolin', t('violin_name'), 'png')" class="text-xs border bg-white px-2 py-1 rounded hover:text-green-600">PNG</button>
                                <button onclick="downloadChartImage('chartViolin', t('violin_name'), 'jpeg')" class="text-xs border bg-white px-2 py-1 rounded hover:text-blue-600">JPEG</button>
                            </div>
                        </div>
                        <div class="h-64 relative w-full"><canvas id="chartViolin"></canvas></div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-slate-700 text-center flex-1" data-i18n="boxplot_name"></h3>
                            <div class="flex gap-1">
                                <button onclick="downloadChartImage('chartBox', t('boxplot_name'), 'png')" class="text-xs border bg-white px-2 py-1 rounded hover:text-green-600">PNG</button>
                                <button onclick="downloadChartImage('chartBox', t('boxplot_name'), 'jpeg')" class="text-xs border bg-white px-2 py-1 rounded hover:text-blue-600">JPEG</button>
                            </div>
                        </div>
                        <div class="h-64 relative w-full"><canvas id="chartBox"></canvas></div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 md:col-span-2">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-slate-700 text-center flex-1" data-i18n="scatter_name"></h3>
                            <div class="flex gap-1">
                                <button onclick="downloadChartImage('chartScatter', t('scatter_name'), 'png')" class="text-xs border bg-white px-2 py-1 rounded hover:text-green-600">PNG</button>
                                <button onclick="downloadChartImage('chartScatter', t('scatter_name'), 'jpeg')" class="text-xs border bg-white px-2 py-1 rounded hover:text-blue-600">JPEG</button>
                            </div>
                        </div>
                        <div class="h-64 relative w-full"><canvas id="chartScatter"></canvas></div>
                    </div>
                </div>

                <h3 class="text-lg font-bold text-slate-800 border-b pb-2 pt-4" data-i18n="structure_cum"></h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                        <div class="flex justify-between items-center mb-4">
                            <div class="flex-1">
                                <h3 class="font-bold text-slate-700 text-sm" data-i18n="pie_chart_name">Pie/Donut</h3>
                                <select id="pieDatasetSelect" onchange="updatePieChart()" class="text-xs border rounded p-1 w-full mt-1"></select>
                            </div>
                            <div class="flex gap-1 ml-2">
                                <button onclick="downloadChartImage('chartPie', t('pie_chart_name'), 'png')" class="text-xs border bg-white px-2 py-1 rounded hover:text-green-600">PNG</button>
                                <button onclick="downloadChartImage('chartPie', t('pie_chart_name'), 'jpeg')" class="text-xs border bg-white px-2 py-1 rounded hover:text-blue-600">JPEG</button>
                            </div>
                        </div>
                        <div class="h-64 relative w-full"><canvas id="chartPie"></canvas></div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-slate-700 text-center flex-1" data-i18n="area_chart_name"></h3>
                            <div class="flex gap-1">
                                <button onclick="downloadChartImage('chartArea', t('area_chart_name'), 'png')" class="text-xs border bg-white px-2 py-1 rounded hover:text-green-600">PNG</button>
                                <button onclick="downloadChartImage('chartArea', t('area_chart_name'), 'jpeg')" class="text-xs border bg-white px-2 py-1 rounded hover:text-blue-600">JPEG</button>
                            </div>
                        </div>
                        <div class="h-64 relative w-full"><canvas id="chartArea"></canvas></div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-slate-700 text-center flex-1" data-i18n="ogive_chart_name"></h3>
                            <div class="flex gap-1">
                                <button onclick="downloadChartImage('chartOgive', t('ogive_chart_name'), 'png')" class="text-xs border bg-white px-2 py-1 rounded hover:text-green-600">PNG</button>
                                <button onclick="downloadChartImage('chartOgive', t('ogive_chart_name'), 'jpeg')" class="text-xs border bg-white px-2 py-1 rounded hover:text-blue-600">JPEG</button>
                            </div>
                        </div>
                        <div class="h-64 relative w-full"><canvas id="chartOgive"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- Empty State Charts -->
            <div id="emptyChartsState" class="hidden h-96 flex flex-col items-center justify-center text-slate-400 bg-slate-50 border-2 border-dashed border-slate-200 rounded-xl mt-6">
                <svg class="w-12 h-12 mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path></svg>
                <p class="text-sm" data-i18n="enter_chart_msg">Vui lòng nhập dữ liệu để xem biểu đồ</p>
            </div>

        </div>
    </div>

    <script>
        // --- State ---
        let mode = 'raw', currentTab = 'data';
        let datasets = [{ id: 1, name: t("sample_a"), dataStr: "45, 52, 60, 48, 55, 62, 49, 58, 65, 51" }];
        let manualRows = [{ id: 1, lower: 40, upper: 50, freqs: {} }, { id: 2, lower: 50, upper: 60, freqs: {} }, { id: 3, lower: 60, upper: 70, freqs: {} }];
        const colors = [
            { bg: 'rgba(59, 130, 246, 0.5)', border: '#2563eb' }, { bg: 'rgba(239, 68, 68, 0.5)', border: '#dc2626' },
            { bg: 'rgba(16, 185, 129, 0.5)', border: '#059669' }, { bg: 'rgba(245, 158, 11, 0.5)', border: '#d97706' },
            { bg: 'rgba(139, 92, 246, 0.5)', border: '#7c3aed' }
        ];
        
        // --- Tabs & Mode ---
        function switchTab(t) {
            currentTab = t;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(t==='data'?'tabDataBtn':'tabChartsBtn').classList.add('active');
            document.getElementById('tabDataContent').classList.toggle('hidden', t!=='data');
            document.getElementById('tabChartsContent').classList.toggle('hidden', t!=='charts');
            if(t==='charts') calculate();
        }
        function switchInputMode(m) {
            mode = m;
            document.getElementById('btnRaw').className = mode==='raw' ? "flex-1 py-2 text-sm font-medium rounded bg-indigo-50 text-indigo-700" : "flex-1 py-2 text-sm font-medium rounded text-slate-500 hover:bg-slate-50";
            document.getElementById('btnTable').className = mode==='table' ? "flex-1 py-2 text-sm font-medium rounded bg-indigo-50 text-indigo-700" : "flex-1 py-2 text-sm font-medium rounded text-slate-500 hover:bg-slate-50";
            document.getElementById('rawSection').classList.toggle('hidden', mode!=='raw');
            document.getElementById('tableSection').classList.toggle('hidden', mode!=='table');
            calculate();
            markAsChanged();
        }

        // --- Dataset Ops ---
        function addDataset() {
            const newId = (datasets.length>0 ? Math.max(...datasets.map(d=>d.id)):0)+1;
            datasets.push({id:newId, name:`${t("sample_prefix")}${String.fromCharCode(65+datasets.length)}`, dataStr:""});
            renderInputs(); calculate();
            markAsChanged();
        }
        function removeLastDataset() { if(datasets.length<=1)return; datasets.pop(); renderInputs(); calculate(); markAsChanged(); }
        function updateRaw(id, val) { datasets.find(d=>d.id===id).dataStr=val; calculate(); markAsChanged(); }
        function updateName(id, val) { datasets.find(d=>d.id===id).name=val; renderInputs(); calculate(); markAsChanged(); }
        
        function deleteDataset(id) {
            if (datasets.length <= 1) return;
            datasets = datasets.filter(d => d.id !== id);
            renderInputs();
            calculate();
            markAsChanged();
        }
        
        function handleCSV(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                try {
                    const rows = text.split(/\r?\n/).filter(row => row.trim() !== "");
                    if (rows.length === 0) return;
                    
                    // Simple CSV parsing (handling commas, semicolons)
                    const delimiter = text.includes(";") ? ";" : ",";
                    const data = rows.map(row => row.split(delimiter).map(cell => cell.trim()));
                    
                    // Check if first row is header (contains non-numeric values)
                    const firstRow = data[0];
                    const isHeader = firstRow.some(cell => isNaN(parseFloat(cell)) && cell !== "");
                    
                    let newDatasets = [];
                    const startIdx = isHeader ? 1 : 0;
                    const colCount = data[0].length;
                    
                    for (let col = 0; col < colCount; col++) {
                        const name = isHeader ? firstRow[col] : `${t("sample_prefix")}${String.fromCharCode(65 + datasets.length + col)}`;
                        const values = [];
                        for (let row = startIdx; row < data.length; row++) {
                            if (data[row][col] !== undefined && data[row][col] !== "") {
                                values.push(data[row][col]);
                            }
                        }
                        if (values.length > 0) {
                            newDatasets.push({
                                id: (datasets.length + newDatasets.length + 1),
                                name: name,
                                dataStr: values.join(", ")
                            });
                        }
                    }
                    
                    if (newDatasets.length > 0) {
                        datasets = [...datasets, ...newDatasets];
                        renderInputs();
                        calculate();
                        markAsChanged();
                        alert(t("csv_import_success"));
                    }
                } catch (err) {
                    console.error(err);
                    alert(t("csv_parse_error"));
                }
                input.value = ""; // Reset input
            };
            reader.readAsText(file);
        }
        function renderInputs() {
            document.getElementById('datasetContainer').innerHTML = datasets.map(ds=>`
              <div class="bg-white border rounded p-2">
                    <div class="flex justify-between items-center mb-1">
                        <input value="${ds.name}" onchange="updateName(${ds.id}, this.value)" class="text-xs font-bold w-20 border-b outline-none focus:border-indigo-500">
                        <button onclick="deleteDataset(${ds.id})" class="text-red-400 hover:text-red-600 transition p-1" title="${t('remove_sample')}">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                    <textarea oninput="updateRaw(${ds.id}, this.value)" class="w-full h-12 text-[10px] font-mono border rounded p-1 resize-none">${ds.dataStr}</textarea>
                </div>`).join('');
            const h = document.getElementById('manualHeaderRow');
            h.innerHTML = `<th class="p-2 w-12" data-i18n="lower_bound">${t('lower_bound')}</th><th class="p-2 w-12" data-i18n="upper_bound">${t('upper_bound')}</th>` + datasets.map(d=>`<th class="p-2 text-center text-indigo-700">${d.name}</th>`).join('') + `<th class="w-6"></th>`;
            renderManualBody();
            updatePieSelect();
        }
        function updatePieSelect() {
            const sel = document.getElementById('pieDatasetSelect');
            sel.innerHTML = datasets.map(d => `<option value="${d.id}">${d.name}</option>`).join('');
        }

        // --- Manual Table ---
        function renderManualBody() {
            document.getElementById('manualBody').innerHTML = manualRows.map(r=>`
                <tr class="border-b hover:bg-slate-50"><td class="p-1"><input type="number" value="${r.lower}" onchange="updRow(${r.id},'lower',this.value)" class="w-full p-1 border rounded text-center input-cell"></td>
                <td class="p-1"><input type="number" value="${r.upper}" onchange="updRow(${r.id},'upper',this.value)" class="w-full p-1 border rounded text-center input-cell"></td>
                ${datasets.map(ds=>`<td class="p-1"><input type="number" value="${r.freqs[ds.id]||0}" min="0" onchange="updRow(${r.id},'freq_${ds.id}',this.value)" class="w-full p-1 border rounded text-center font-bold text-indigo-600 input-cell"></td>`).join('')}
                <td class="p-1"><button onclick="delRow(${r.id})" class="text-red-300 hover:text-red-500">x</button></td></tr>`).join('');
        }
        function addManualRow() {
            const last = manualRows[manualRows.length-1];
            let l = last?last.upper:0, w = last?(last.upper-last.lower)||10:10;
            manualRows.push({id:Date.now(), lower:l, upper:l+w, freqs:{}}); renderManualBody(); calculate();
            markAsChanged();
        }
        function delRow(id) { if(manualRows.length>1) { manualRows=manualRows.filter(r=>r.id!==id); renderManualBody(); calculate(); markAsChanged(); } }
        function updRow(id, f, val) {
            const r = manualRows.find(x=>x.id===id); if(!r)return;
            if(f.startsWith('freq')) r.freqs[parseInt(f.split('_')[1])] = parseInt(val)||0;
            else { 
                r[f]=parseFloat(val); 
                if(manualRows.indexOf(r)===0 && (f==='lower'||f==='upper')) {
                   const w = manualRows[0].upper - manualRows[0].lower;
                   if(w>0) { for(let i=1;i<manualRows.length;i++){ manualRows[i].lower=manualRows[i-1].upper; manualRows[i].upper=manualRows[i].lower+w;} renderManualBody(); } 
                }
            }
            calculate();
            markAsChanged();
        }

        // --- Core Calc ---
        let lastGroups = [], lastResults = [];

        function calculate() {
            let groups = [], results = [];
            const resultsSection = document.getElementById('resultsSection');
            const emptyState = document.getElementById('emptyState');
            const chartsWrapper = document.getElementById('chartsWrapper');
            const emptyChartsState = document.getElementById('emptyChartsState');

            if(mode==='raw') {
                const pDS = datasets.map(d => ({...d, data: d.dataStr.split(/[\s,;]+/).map(x=>parseFloat(x)).filter(n=>!isNaN(n)).sort((a,b)=>a-b)})).filter(d=>d.data.length>0);
                if(pDS.length===0) { 
                    resultsSection.classList.add('hidden'); emptyState.classList.remove('hidden'); 
                    chartsWrapper.classList.add('hidden'); emptyChartsState.classList.remove('hidden');
                    return;
                }
                const all = pDS.flatMap(d=>d.data), min=Math.min(...all), max=Math.max(...all);
                const meth = document.getElementById('method').value, uStart=document.getElementById('startValue').value;
                let start=uStart!==""?parseFloat(uStart):min, k=5, h=10;
                
                if(meth==='auto'){ k=Math.ceil(1+3.322*Math.log10(all.length)); h=Math.ceil((max-start)/k)||1; }
                else if(meth==='manual_width'){ h=parseFloat(document.getElementById('manualH').value)||5; k=Math.ceil((max-start)/h); if(start+k*h<=max)k++;}
                else { k=parseInt(document.getElementById('manualK').value)||5; h=(max-start)/k; }

                for(let i=0;i<k;i++) groups.push({id:i+1, lower:start+i*h, upper:start+(i+1)*h, midpoint:start+i*h+h/2});
                results = pDS.map((ds,i)=> processStats(ds.name, groups, colors[i%colors.length], ds.data, null));
            } else {
                groups = manualRows.map((r,i)=>({id:i+1, lower:r.lower, upper:r.upper, midpoint:(r.lower+r.upper)/2}));
                results = datasets.map((ds,i)=> processStats(ds.name, groups, colors[i%colors.length], null, ds.id));
            }
            
            const hasData = results.some(r => r.s.N > 0);
            if(hasData) {
                resultsSection.classList.remove('hidden'); emptyState.classList.add('hidden');
                chartsWrapper.classList.remove('hidden'); emptyChartsState.classList.add('hidden');
                lastGroups = groups; lastResults = results;
                renderTables(groups, results);
                if(currentTab==='charts') updateAllCharts(groups, results);
            } else {
                resultsSection.classList.add('hidden'); emptyState.classList.remove('hidden');
                chartsWrapper.classList.add('hidden'); emptyChartsState.classList.remove('hidden');
            }
        }

        function processStats(name, groups, color, rawData, dsId) {
            let cf=0;
            const gStats = groups.map((g, idx) => {
                let freq = 0;
                if(rawData) freq = (idx===groups.length-1) ? rawData.filter(x=>x>=g.lower && x<=g.upper+0.0001).length : rawData.filter(x=>x>=g.lower && x<g.upper).length;
                else freq = manualRows[idx].freqs[dsId] || 0;
                cf += freq;
                return {...g, freq, cf};
            });
            const N = cf;
            if(N===0) return {name, color, gStats, rawData: rawData||[], s:{N:0}};
            
            const mean = gStats.reduce((s,g)=>s+g.freq*g.midpoint,0)/N;
            const variance = gStats.reduce((s,g)=>s+g.freq*Math.pow(g.midpoint-mean,2),0)/N;
            const sd = Math.sqrt(variance);
            const cv = mean!==0 ? (sd/Math.abs(mean))*100 : 0;
            
            let trueMean=null, absErr=null, relErr=null, outliers=[], range=0;
            if(rawData) {
                trueMean = rawData.reduce((a,b)=>a+b,0)/N; absErr = Math.abs(trueMean-mean); relErr = trueMean!==0 ? (absErr/Math.abs(trueMean))*100 : 0;
                range = rawData[rawData.length-1] - rawData[0];
            } else {
                const ag = gStats.filter(g=>g.freq>0);
                if(ag.length) range = ag[ag.length-1].upper - ag[0].lower;
            }

            const getQ = (t) => {
                const g = gStats.find(x => x.cf >= t - 0.000001);
                if (!g) {
                    const lastG = gStats[gStats.length - 1];
                    return { val: lastG.upper, grp: `[${fmt(lastG.lower)}; ${fmt(lastG.upper)})`, idx: gStats.length - 1 };
                }
                const idx = gStats.indexOf(g);
                const prev = idx > 0 ? gStats[idx - 1].cf : 0;
                // Tránh chia cho 0 nếu tần số nhóm bằng 0 (dù cf >= t thì freq thường > 0)
                const val = g.freq > 0 ? g.lower + ((t - prev) / g.freq) * (g.upper - g.lower) : g.lower;
                return { val: val, grp: `[${fmt(g.lower)}; ${fmt(g.upper)})`, idx: idx };
            };
            const q1 = getQ(N/4), q2=getQ(N/2), q3=getQ(3*N/4);
            const iqr = q3.val - q1.val;

            let maxF=-1, mG=null; gStats.forEach(g=>{if(g.freq>maxF){maxF=g.freq; mG=g;}});
            let mode = 0;
            if(mG) {
                const i=gStats.indexOf(mG), p=(i>0?gStats[i-1].freq:0), n=(i<gStats.length-1?gStats[i+1].freq:0);
                mode = mG.lower + ((mG.freq-p)/((mG.freq-p)+(mG.freq-n)))*(mG.upper-mG.lower);
            }

            if(rawData) {
                const lf=q1.val-1.5*iqr, uf=q3.val+1.5*iqr;
                outliers=rawData.filter(x=>x<lf||x>uf);
            }

            return { name, color, gStats, rawData: rawData || generateSimulatedData(gStats), s: {
                N, mean, trueMean, absErr, relErr, variance, sd, cv, range,
                q1:q1.val, q2:q2.val, q3:q3.val, iqr, mode, 
                q1Loc:q1.grp, q2Loc:q2.grp, q3Loc:q3.grp,
                q1Idx:q1.idx, q2Idx:q2.idx, q3Idx:q3.idx,
                outliers, disp: cv<10?t("low"):cv<30?t("medium"):t("high")
            }};
        }

        function generateSimulatedData(gStats) {
            let data = [];
            gStats.forEach(g => {
                for(let i=0; i<g.freq; i++) {
                    const jitter = (Math.random() - 0.5) * (g.upper - g.lower) * 0.8;
                    data.push(g.midpoint + jitter);
                }
            });
            return data.sort((a,b)=>a-b);
        }

        function renderTables(groups, results) {
            const m = [
                {id:'N', l:t('total_n')}, {id:'trueMean', l:t('true_mean'), raw:1}, {id:'mean', l:t('approx_mean'), calc:1},
                {id:'absErr', l:t('abs_err'), raw:1}, {id:'relErr', l:t('rel_err'), raw:1},
                {id:'q2', l:t('median'), calc:1}, {id:'q1', l:t('q1'), calc:1}, {id:'q3', l:t('q3'), calc:1}, {id:'mode', l:t('mode'), calc:1},
                {id:'range', l:t('range'), calc:1}, {id:'iqr', l:t('iqr'), calc:1}, {id:'variance', l:t('variance'), calc:1},
                {id:'sd', l:t('sd'), calc:1}, {id:'cv', l:t('cv'), calc:1}, {id:'disp', l:t('dispersion_level'), txt:1},
                {id:'outliers', l:t('outliers_count'), raw:1, len:1},
                {id:'q1Loc', l:t('q1_loc'), txt:1}, {id:'q2Loc', l:t('q2_loc'), txt:1}, {id:'q3Loc', l:t('q3_loc'), txt:1}
            ];
            let h = `<thead><tr class="bg-indigo-50 border-b"><th class="px-4 py-2" data-i18n="metric_col">${t('metric_col')}</th>`+results.map(r=>`<th class="px-4 py-2 text-center" style="color:${r.color.border}">${r.name}</th>`).join('')+`</tr></thead><tbody>`;
            m.forEach(x => {
                h += `<tr class="border-b last:border-0 hover:bg-slate-50"><td class="px-4 py-2 font-medium text-slate-600 flex items-center justify-between gap-2">${x.l}</td>` + results.map((r, rIdx)=>{
                    let v = r.s[x.id];
                    // Mã hóa dữ liệu để truyền an toàn qua HTML attribute
                    const rData = encodeURIComponent(JSON.stringify({name: r.name, s: r.s, gStats: r.gStats}));
                    const gData = encodeURIComponent(JSON.stringify(groups));
                    let calcBtn = x.calc ? `<button onclick="showCalculation('${x.id}', '${rData}', '${gData}')" class="p-1 text-indigo-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-full transition ml-1" title="${t('view_calc_detail')}"><svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></button>` : '';
                    if(x.raw && mode==='table') return `<td class="text-center text-slate-300 italic">N/A</td>`;
                    if(v===undefined) return `<td>-</td>`;
                    if(x.len) return `<td class="text-center font-bold text-red-600">${v.length}</td>`;
                    if(x.txt) return `<td class="text-center text-slate-700">${v}</td>`;
                    return `<td class="text-center font-bold text-slate-700">${fmt(v)}${calcBtn}</td>`;
                }).join('') + `</tr>`;
            });
            document.getElementById('statsTable').innerHTML = h+`</tbody>`;

            let groupTitle = document.getElementById('groupColumnTitle')?.innerText || t("group");
            let fh = `<thead><tr class="bg-indigo-50 border-b"><th class="px-4 py-2 outline-none focus:ring-2 focus:ring-indigo-500" contenteditable="true" id="groupColumnTitle" onblur="calculate()">${groupTitle}</th><th class="px-4 py-2 text-center" data-i18n="rep_val">${t('rep_val')}</th>`+results.map(r=>`<th class="px-4 py-2 text-center" style="color:${r.color.border}" data-i18n="freq">${t('freq')}</th>`).join('')+`</tr></thead><tbody>`;
            groups.forEach((g,i)=>{
                fh += `<tr class="border-b hover:bg-slate-50"><td class="px-4 py-2 text-slate-800">[${fmt(g.lower)}; ${fmt(g.upper)})</td><td class="px-4 py-2 text-center text-slate-500">${fmt(g.midpoint)}</td>`+results.map(r=>`<td class="px-4 py-2 text-center font-bold">${r.gStats[i].freq}</td>`).join('')+`</tr>`;
            });
            document.getElementById('freqTable').innerHTML = fh+`</tbody>`;
        }

        let charts = {};
        function updateAllCharts(groups, results) {
            const l = groups.map(g=>`[${fmt(g.lower)}; ${fmt(g.upper)})`);
            const ol = [fmt(groups[0].lower), ...groups.map(g=>fmt(g.upper))]; 
            const ds = (fn, type, fill) => results.map(r=>({
                label: r.name, data: fn(r), backgroundColor: r.color.bg, borderColor: r.color.border, 
                borderWidth: 1.5, tension: 0.3, fill: fill
            }));

            draw('chartHistogram', 'bar', l, ds(r=>r.gStats.map(g=>g.freq), 'bar', false), {scales:{x:{stacked:false},y:{beginAtZero:true}}});
            draw('chartPolygon', 'line', groups.map(g=>fmt(g.midpoint)), ds(r=>r.gStats.map(g=>g.freq), 'line', false), {elements:{line:{tension:0}}});
            draw('chartStacked', 'bar', l, ds(r=>r.gStats.map(g=>g.freq), 'bar', false), {scales:{x:{stacked:true},y:{stacked:true}}});
            draw('chartRelFreq', 'bar', l, ds(r=>r.gStats.map(g=>(g.freq/r.s.N)*100), 'bar', false), {scales:{y:{beginAtZero:true, title:{display:true,text:'%'}}}});
            draw('chartArea', 'line', l, ds(r=>r.gStats.map(g=>g.freq), 'line', true), {scales:{y:{stacked:true, beginAtZero:true}}, elements:{line:{tension:0.4}}});
            draw('chartOgive', 'line', ol, ds(r=>[0, ...r.gStats.map(g=>g.cf)], 'line', false), {elements:{line:{tension:0.2}}});
            updatePieChart();

            const boxData = results.map(r => ({ label: r.name, backgroundColor: r.color.bg, borderColor: r.color.border, borderWidth: 1, outlierColor: '#ef4444', padding: 10, itemRadius: 0, data: [r.rawData] }));
            draw('chartBox', 'boxplot', [t('distribution')], boxData, {});

            const violinData = results.map(r => ({ label: r.name, backgroundColor: r.color.bg, borderColor: r.color.border, borderWidth: 1, data: [r.rawData] }));
            draw('chartViolin', 'violin', [t('density')], violinData, {});

            const scatterData = results.map(r => ({ label: r.name, backgroundColor: r.color.border, data: r.rawData.map((val, idx) => ({ x: val, y: Math.random() * 0.5 + results.indexOf(r) })) }));
            draw('chartScatter', 'scatter', null, scatterData, { scales: { x: { type: 'linear', position: 'bottom', title: {display:true, text: t('value_col')} }, y: { display: false } } });
        }

        function updatePieChart() {
            const dsId = parseInt(document.getElementById('pieDatasetSelect').value) || (datasets[0]?datasets[0].id:0);
            const dataset = datasets.find(d => d.id === dsId);
            if(!dataset || !lastGroups.length) return;
            let gStats = [];
            if(mode==='raw') {
                const data = dataset.dataStr.split(/[\s,;]+/).map(x=>parseFloat(x)).filter(n=>!isNaN(n));
                gStats = lastGroups.map(g => ({...g, freq: data.filter(x=>x>=g.lower && x<g.upper).length}));
            } else {
                gStats = lastGroups.map((g,i) => ({...g, freq: manualRows[i].freqs[dsId]||0}));
            }
            const data = { labels: lastGroups.map(g => `[${fmt(g.lower)}; ${fmt(g.upper)})`), datasets: [{ data: gStats.map(g => g.freq), backgroundColor: ['#60a5fa','#f87171','#34d399','#fbbf24','#a78bfa','#f472b6','#9ca3af'] }] };
            draw('chartPie', 'doughnut', data.labels, data.datasets, {});
        }

        function draw(id, type, l, d, opt) {
            const ctx = document.getElementById(id).getContext('2d');
            if(charts[id]) charts[id].destroy();
            charts[id] = new Chart(ctx, {type, data:{labels:l, datasets:d}, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom'}}, ...opt}});
        }

        // --- Download Functions ---
        function downloadCalcImage() {
            const element = document.getElementById('calcModalContent');
            const randomId = generateRandomFilename();
            const fileName = `Calculation_${randomId}.png`;

            html2canvas(element, { scale: 2, backgroundColor: '#ffffff' }).then(canvas => {
                const link = document.createElement('a');
                link.href = canvas.toDataURL('image/png');
                link.download = fileName;
                link.click();
            });
        }

        function downloadTableImage(tableId, baseName, format) {
            const element = document.getElementById(tableId);
            const randomId = generateRandomFilename();
            const fileName = `${baseName.replace(/\s+/g, '_')}_${randomId}.${format}`;

            html2canvas(element, { scale: 2, backgroundColor: '#ffffff' }).then(canvas => {
                const link = document.createElement('a');
                link.href = canvas.toDataURL(`image/${format === 'jpg' ? 'jpeg' : format}`);
                link.download = fileName;
                link.click();
            });
        }

        function downloadChartImage(chartId, baseName, format) {
            const chart = charts[chartId];
            if (!chart) {
                alert(t('chart_not_created'));
                return;
            }
            
            const randomId = generateRandomFilename();
            const fileName = `${baseName.replace(/\s+/g, '_')}_${randomId}.${format}`;

            const canvas = chart.canvas;
            const link = document.createElement('a');
            link.href = chart.toBase64Image(`image/${format}`); // Sử dụng hàm của Chart.js để lấy base64 image
            link.download = fileName;
            link.click();
        }

        function fmt(n) { 
            const d = parseInt(document.getElementById('decimalPlaces').value) || 2; 
            const lang = typeof currentLang !== 'undefined' ? currentLang : (localStorage.getItem('aav_lang') || 'vi');
            const localeMap = {
                'vi': 'vi-VN', 'en': 'en-US', 'zh': 'zh-CN', 'hi': 'hi-IN', 'es': 'es-ES',
                'fr': 'fr-FR', 'ar': 'ar-SA', 'bn': 'bn-BD', 'pt': 'pt-PT', 'ru': 'ru-RU', 'ur': 'ur-PK'
            };
            return (n === undefined || n === null) ? "-" : new Intl.NumberFormat(localeMap[lang] || 'en-US', { minimumFractionDigits: d, maximumFractionDigits: d }).format(n); 
        }
        function toggleInputs() { const m=document.getElementById('method').value; document.getElementById('inputH').classList.toggle('hidden', m!=='manual_width'); document.getElementById('inputK').classList.toggle('hidden', m!=='manual_count'); document.getElementById('inputStart').classList.toggle('hidden', m==='auto'); }
        function copyTable() { 
            const el = document.getElementById('freqTable'); let range, sel;
            if (document.createRange && window.getSelection) { range = document.createRange(); sel = window.getSelection(); sel.removeAllRanges(); try { range.selectNodeContents(el); sel.addRange(range); } catch (e) { range.selectNode(el); sel.addRange(range); } document.execCommand("copy"); sel.removeAllRanges(); alert(t("copied")); }
        }

        // --- Sharing Feature ---
        function shareLink() {
            const state = {
                m: mode,
                ds: datasets.map(d => ({ n: d.name, s: d.dataStr })),
                mr: manualRows.map(r => ({ l: r.lower, u: r.upper, f: r.freqs })),
                dp: document.getElementById('decimalPlaces').value,
                meth: document.getElementById('method').value,
                h: document.getElementById('manualH').value,
                k: document.getElementById('manualK').value,
                sv: document.getElementById('startValue').value
            };

            if (state.dp == "2") delete state.dp;
            if (state.meth == "auto") {
                delete state.meth; delete state.h; delete state.k; delete state.sv; delete state.mr;
            } else {
                if (state.h == "5") delete state.h;
                if (state.k == "6") delete state.k;
                if (state.sv === "" || state.sv === null) delete state.sv;
            }
            if (state.m === 'raw') delete state.m;

            const json = JSON.stringify(state);
            const compressed = LZString.compressToEncodedURIComponent(json);
            
            // Link dài với fragment
            const url = new URL(window.location.origin + window.location.pathname);
            url.hash = 'share=' + compressed;
            const fullUrl = url.toString();
            
            // Thử rút gọn qua is.gd trước
            const callbackName = 'shortenCallback_' + Date.now();
            window[callbackName] = function(response) {
                delete window[callbackName];
                let shortUrl = fullUrl;
                if (response.shorturl) {
                    shortUrl = response.shorturl;
                }
                
                const markdownLink = `[AAV Content](${shortUrl})`;
                navigator.clipboard.writeText(shortUrl).then(() => {
                    alert(t("share_link_copied") + "\n\n" + shortUrl);
                }).catch(err => {
                    prompt(t("copy_share_link_here"), shortUrl);
                });
            };
            
            const script = document.createElement('script');
            script.src = `https://is.gd/create.php?format=json&callback=${callbackName}&url=${encodeURIComponent(fullUrl)}`;
            script.onerror = function() {
                delete window[callbackName];
                navigator.clipboard.writeText(fullUrl).then(() => {
                    alert(t("share_link_copied") + "\n\n" + fullUrl);
                }).catch(err => {
                    prompt(t("copy_share_link_here"), fullUrl);
                });
            };
            document.head.appendChild(script);
        }

        function loadSharedData() {
            // Ho tro ca query parameter (?) va fragment identifier (#)
            let sharedData = null;
            
            // Kiem tra fragment identifier truoc (uu tien)
            if (window.location.hash) {
                const hashParams = new URLSearchParams(window.location.hash.substring(1));
                sharedData = hashParams.get('share');
            }
            
            // Neu khong co fragment, kiem tra query parameter (tuong thich nguoc)
            if (!sharedData) {
                const params = new URLSearchParams(window.location.search);
                sharedData = params.get('share');
            }
            
            if (!sharedData) return;

            try {
                let json;
                // Thử giải nén bằng LZString trước
                const decompressed = LZString.decompressFromEncodedURIComponent(sharedData);
                
                if (decompressed) {
                    json = decompressed;
                } else {
                    // Nếu thất bại, thử giải mã Base64 (tương thích ngược với các link cũ)
                    json = decodeURIComponent(escape(atob(sharedData)));
                }

                const state = JSON.parse(json);
                
                if (state.m) mode = state.m;
                if (state.ds) datasets = state.ds.map((d, i) => ({ id: i + 1, name: d.n, dataStr: d.s }));
                if (state.mr) manualRows = state.mr.map((r, i) => ({ id: Date.now() + i, lower: r.l, upper: r.u, freqs: r.f }));
                
                if (state.dp) document.getElementById('decimalPlaces').value = state.dp;
                if (state.meth) document.getElementById('method').value = state.meth;
                if (state.h) document.getElementById('manualH').value = state.h;
                if (state.k) document.getElementById('manualK').value = state.k;
                if (state.sv) document.getElementById('startValue').value = state.sv;

                toggleInputs();
                if (mode === 'table') {
                    document.getElementById('btnRaw').className = "flex-1 py-2 text-sm font-medium rounded text-slate-500 hover:bg-slate-50";
                    document.getElementById('btnTable').className = "flex-1 py-2 text-sm font-medium rounded bg-indigo-50 text-indigo-700";
                    document.getElementById('rawSection').classList.add('hidden');
                    document.getElementById('tableSection').classList.remove('hidden');
                }
            } catch (e) {
                console.error("Error loading shared data:", e);
            }
        }

        // --- Home Navigation ---
        function goHome() {
            // Chuyển về tab "<span data-i18n="data_stats">Dữ liệu & Thống kê</span>"
            switchTab('data');
            // Cuộn lên đầu trang
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        window.onload = () => { 
            // Khôi phục từ localStorage trước
            const restored = restoreFromLocalStorage();
            
            // Uu tien tai du lieu tu shared link neu co (ho tro ca fragment va query parameter)
            const hasFragmentShare = window.location.hash && window.location.hash.includes('share=');
            const params = new URLSearchParams(window.location.search);
            const hasQueryShare = params.has('share');
            
            if (hasFragmentShare || hasQueryShare) {
                loadSharedData();
            } else if (!restored) {
                // Neu khong co link chia se, moi khoi phuc tu localStorage
                // (Dieu nay tranh viec du lieu cu de len du lieu moi duoc chia se)
            }
            
            // Khởi tạo hệ thống auto-backup
            initAutoBackup();
            
            renderInputs(); 
            calculate();
            
            // Thêm event listener cho decimalPlaces
            document.getElementById('decimalPlaces').addEventListener('change', markAsChanged);
            document.getElementById('method').addEventListener('change', markAsChanged);
            document.getElementById('manualH').addEventListener('change', markAsChanged);
            document.getElementById('manualK').addEventListener('change', markAsChanged);
            document.getElementById('startValue').addEventListener('change', markAsChanged);
        };
    </script>
    <footer class="mt-12 py-8 border-t border-slate-200 text-center text-slate-500 text-sm">
        <p data-i18n="footer_text">© 2026 AAV - Công cụ Phân Tích Dữ Liệu. Cập nhật mới nhất: 07/01/2026</p>
        <p class="mt-1"><span data-i18n="developed_by">Phát triển bởi</span> <a href="https://github.com/lucdai" class="text-indigo-600 hover:underline">lucdai</a></p>
    </footer>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>
    <script src="calculation_details.js"></script>
</body>
</html>
